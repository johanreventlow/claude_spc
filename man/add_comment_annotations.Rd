% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fct_spc_bfh_service.R
\name{add_comment_annotations}
\alias{add_comment_annotations}
\title{Add Comment Annotations to SPC Plot}
\usage{
add_comment_annotations(
  plot,
  qic_data,
  original_data,
  notes_column,
  config = NULL
)
}
\arguments{
\item{plot}{ggplot2 object. Base SPC plot from BFHchart or SPCify.}

\item{qic_data}{data.frame. Standardized SPC data with \code{.original_row_id} column.}

\item{original_data}{data.frame. Original input data with comment column.}

\item{notes_column}{character. Name of column containing comment text in
\code{original_data}. Comments must be character strings.}

\item{config}{list. Optional comment configuration overriding defaults.
Keys: \code{max_length}, \code{display_length}, \code{truncate_length},
\code{font_size}, \code{color}. Default NULL (use defaults).}
}
\value{
ggplot2 object. Original plot with added \code{geom_text_repel} layer
for comments. Returns original plot unchanged if:
\itemize{
\item \code{notes_column} is NULL or empty string
\item \code{notes_column} not found in \code{original_data}
\item No non-empty comments found
\item \code{.original_row_id} column missing (with warning)
Returns NULL on error (with structured logging).
}
}
\description{
Applies comment/notes annotations to SPC plot as a ggrepel layer. Handles
stable row mapping, XSS sanitization, Danish character support, and collision
avoidance. This function implements SPCify's comment handling pattern,
independent of BFHchart's native notes support.
}
\details{
\strong{Comment Handling Workflow:}
\enumerate{
\item Extract comment data from original dataset using \code{notes_column}
\item Join with \code{qic_data} via \code{.original_row_id} (stable row mapping)
\item Filter to non-empty comments only
\item Sanitize comment text (XSS protection, Danish chars æøå preserved)
\item Truncate long comments (40 char display, 100 char max)
\item Apply \code{ggrepel::geom_text_repel()} layer with collision avoidance
\item Style: arrows, box padding, max overlaps configuration
}

\strong{Stable Row Mapping:}
Uses \code{.original_row_id} column (injected in \code{map_to_bfh_params}) to ensure
comments map correctly even if BFHchart reorders/filters rows internally.

\strong{XSS Sanitization:}
\itemize{
\item HTML escape: \code{<}, \code{>}, \code{&}, \verb{"}, \verb{'}
\item Character whitelist: A-Z, a-z, 0-9, æøåÆØÅ, space, \verb{.,:-!?}
\item Max length enforcement: 100 characters
\item Truncation indicator: \code{...} appended if >40 chars
}

\strong{Visual Configuration:}
\itemize{
\item Font size: 8pt
\item Color: Dark gray (#333333)
\item Arrow: 0.015 npc length
\item Box padding: 0.5
\item Point padding: 0.5
\item Max overlaps: Inf (show all comments)
}
}
\examples{
\dontrun{
# Add comments to SPC plot
plot_with_comments <- add_comment_annotations(
  plot = base_plot,
  qic_data = standardized_data,
  original_data = raw_data,
  notes_column = "Kommentar"
)

# Custom comment configuration
plot_with_comments <- add_comment_annotations(
  plot = base_plot,
  qic_data = standardized_data,
  original_data = raw_data,
  notes_column = "Notes",
  config = list(
    max_length = 150,
    display_length = 50,
    font_size = 10,
    color = "#000000"
  )
)

# Integrate with facade
result <- compute_spc_results_bfh(
  data = data,
  x_var = "date",
  y_var = "value",
  chart_type = "run",
  notes_column = "Comment"
)
# Comments automatically applied in facade
print(result$plot)
}

}
\seealso{
\code{\link{compute_spc_results_bfh}} for facade interface with integrated comments
}
