# utils_logging.R
# Konfigurerbart logging system til SPC App

#' Log levels liste til SPC App logging system
#'
#' @description
#' Definerer numeriske værdier for forskellige log niveauer til brug i det
#' konfigurerede logging system. Lavere værdier betyder højere prioritet.
#'
#' @details
#' Log levels:
#' - DEBUG (1): Detaljeret debug information
#' - INFO (2): Generel information
#' - WARN (3): Advarsler
#' - ERROR (4): Fejl beskeder
#'
#' @format Liste med 4 elementer
#' @export
LOG_LEVELS <- list(
  DEBUG = 1,
  INFO = 2,
  WARN = 3,
  ERROR = 4
)

#' Hent aktuel log level fra environment variable
#'
#' @description
#' Læser SPC_LOG_LEVEL environment variablen og returnerer den tilsvarende
#' numeriske værdi. Falder tilbage til INFO hvis variablen ikke er sat eller
#' indeholder en ugyldig værdi.
#'
#' @return Numerisk værdi svarende til log level (se LOG_LEVELS)
#' @export
#'
#' @examples
#' # Standard opførsel (INFO level)
#' get_log_level()
#'
#' # Med DEBUG environment variable
#' Sys.setenv(SPC_LOG_LEVEL = "DEBUG")
#' get_log_level()  # Returns 1
get_log_level <- function() {
  env_level <- Sys.getenv("SPC_LOG_LEVEL", "INFO")
  level_num <- LOG_LEVELS[[toupper(env_level)]]
  if (is.null(level_num)) {
    return(LOG_LEVELS$INFO)
  }
  return(level_num)
}

#' Primær logging funktion med konfigureret level filtering
#'
#' @description
#' Central logging funktion der håndterer alle log beskeder med automatisk
#' level filtering baseret på SPC_LOG_LEVEL environment variabel.
#'
#' @param message Besked der skal logges (karakter string)
#' @param level Log level som string. Gyldige værdier: "DEBUG", "INFO", "WARN", "ERROR"
#' @param component Valgfri komponent tag for organisering (f.eks. "AUTO_DETECT", "FILE_UPLOAD")
#'
#' @return Returnerer invisible(NULL). Beskeder skrives til console hvis level er tilstrækkelig høj
#' @export
#'
#' @details
#' Funktionen checker den aktuelle log level (fra SPC_LOG_LEVEL environment variable)
#' og viser kun beskeder hvis deres level er høj nok. Beskeder formateres med
#' timestamp, level og valgfri komponent tag.
#'
#' @examples
#' # Grundlæggende brug
#' log_msg("System startet", "INFO")
#'
#' # Med komponent tag
#' log_msg("Data læst succesfuldt", "INFO", "FILE_UPLOAD")
#'
#' # Debug besked (kun vist hvis SPC_LOG_LEVEL=DEBUG)
#' log_msg("Processerer række 42", "DEBUG", "DATA_PROC")
log_msg <- function(message, level = "INFO", component = NULL) {
  current_level <- get_log_level()
  msg_level <- LOG_LEVELS[[toupper(level)]]

  if (is.null(msg_level) || msg_level < current_level) {
    return(invisible(NULL))
  }

  timestamp <- format(Sys.time(), "%H:%M:%S")
  component_str <- if (!is.null(component)) paste0("[", component, "] ") else ""

  cat(sprintf("[%s] %s: %s%s\n",
              timestamp,
              toupper(level),
              component_str,
              message))
}

#' Log debug besked (kun vist ved DEBUG log level) - Variadisk og fejlsikker
#'
#' @description Convenience funktion til logging af debug beskeder. Accepterer
#' variable antal argumenter og er fejlsikker for at undgå renderPlot crashes.
#'
#' @param ... Variable argumenter der skal sammenkædes til debug besked
#' @param .context Valgfri kontekst tag (f.eks. "RENDER_PLOT", "AUTO_DETECT")
#' @export
#'
#' @examples
#' # Basis brug
#' log_debug("Processerer data række")
#'
#' # Med kontekst
#' log_debug("Column config check:", TRUE, .context = "RENDER_PLOT")
#'
#' # Multiple argumenter
#' log_debug("Status:", status_var, "for fil:", filename)
log_debug <- function(..., .context = NULL) {
  tryCatch({
    msg <- paste(..., collapse = " ")
    log_msg(msg, "DEBUG", component = .context)
  }, error = function(e) {
    # Fejlsikker fallback - aldrig crash renderPlot
    try(cat("DEBUG: [LOGGING_ERROR] Could not format debug message\n"), silent = TRUE)
  })
  invisible(NULL)
}

#' Log information besked
#'
#' @description Convenience funktion til logging af information beskeder.
#'
#' @param message Information besked der skal logges
#' @param component Valgfri komponent tag (f.eks. "FILE_UPLOAD")
#' @export
#'
#' @examples
#' log_info("Fil uploaded succesfuldt", "FILE_UPLOAD")
log_info <- function(message, component = NULL) {
  log_msg(message, "INFO", component)
}

#' Log warning besked
#'
#' @description Convenience funktion til logging af advarsels beskeder.
#'
#' @param message Warning besked der skal logges
#' @param component Valgfri komponent tag (f.eks. "DATA_VALIDATION")
#' @export
#'
#' @examples
#' log_warn("Manglende data i kolonne", "DATA_VALIDATION")
log_warn <- function(message, component = NULL) {
  log_msg(message, "WARN", component)
}

#' Log error besked
#'
#' @description Convenience funktion til logging af fejl beskeder.
#'
#' @param message Error besked der skal logges
#' @param component Valgfri komponent tag (f.eks. "ERROR_HANDLING")
#' @export
#'
#' @examples
#' log_error("Kunne ikke læse fil", "FILE_UPLOAD")
log_error <- function(message, component = NULL) {
  log_msg(message, "ERROR", component)
}

#' Log debug block start/stop med separator linjer
#'
#' @description Helper funktion til logging af debug blokke med visuelt adskilte
#' start/stop sektioner. Erstatter hardcodede separator linjer i koden.
#'
#' @param context Kontekst tag for blokken (f.eks. "COLUMN_MGMT", "AUTO_DETECT")
#' @param action Beskrivelse af handlingen (f.eks. "Starting column management", "Processing data")
#' @param type Type af separator: "start", "stop", eller "both" (default)
#' @export
#'
#' @examples
#' log_debug_block("COLUMN_MGMT", "Starting column detection")
#' # Kode her...
#' log_debug_block("COLUMN_MGMT", "Column detection completed", type = "stop")
log_debug_block <- function(context, action, type = "start") {
  separator_line <- paste(rep("=", 43), collapse = "")

  if (type %in% c("start", "both")) {
    log_debug(separator_line, .context = context)
    log_debug(action, .context = context)
  }

  if (type == "stop") {
    log_debug(paste(action, "- completed"), .context = context)
    log_debug(separator_line, .context = context)
  }

  if (type == "both") {
    log_debug(separator_line, .context = context)
  }
}

#' Log key-value pairs struktureret
#'
#' @description Helper funktion til logging af strukturerede key-value data.
#' Understøtter både navngivne argumenter og lister.
#'
#' @param ... Navngivne argumenter der skal logges som key-value pairs
#' @param .context Kontekst tag (f.eks. "DATA_PROC", "AUTO_DETECT")
#' @param .list_data Optional liste med key-value data
#' @export
#'
#' @examples
#' log_debug_kv(trigger_value = 1, status = "active", .context = "DATA_TABLE")
#' log_debug_kv(.list_data = list(rows = 100, cols = 5), .context = "DATA_PROC")
log_debug_kv <- function(..., .context = NULL, .list_data = NULL) {
  # Handle named arguments
  named_args <- list(...)
  if (length(named_args) > 0) {
    for (key in names(named_args)) {
      if (!is.null(key) && key != "") {
        value <- named_args[[key]]
        log_debug(paste0(key, ": ", as.character(value)), .context = .context)
      }
    }
  }

  # Handle list data
  if (!is.null(.list_data) && is.list(.list_data)) {
    for (key in names(.list_data)) {
      if (!is.null(key) && key != "") {
        value <- .list_data[[key]]
        log_debug(paste0(key, ": ", as.character(value)), .context = .context)
      }
    }
  }
}